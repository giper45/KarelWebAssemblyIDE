#ifndef CANVAS_MAIN_H_
#define CANVAS_MAIN_H_

#include <canvas.h>

void setup();
void loop(double timeSec, double elapsedSec);

// TODO: move this into a library.
int main() {
  const int RAF_PROC_EXIT_CODE = 0xC0C0A;
  setup();
  canvas_requestAnimationFrame();
  return RAF_PROC_EXIT_CODE;
}

#define WASM_EXPORT __attribute__((__visibility__("default")))

bool is_already_called = false;
extern "C" WASM_EXPORT void canvas_loop(double msec) {
  static bool first = true;
  static double lastSec = 0;
  static double lastLoopSec = 0;
  double sec = msec / 1000.0;
  // if (first) {
  //   lastSec = sec;
  //   lastLoopSec = sec;
  //   first = false;
  // }
  // lastLoopSec = sec;

  canvas_requestAnimationFrame();
  
  // Call loop only once per second
  // if (sec - lastLoopSec >= 1.0) {
  if (sec - lastLoopSec >= 1.0) {
    // if (!is_already_called) {
      // loop(sec, 1.0);  // Always pass 1.0 as elapsed time for consistent timing
      // is_already_called = true;
      lastLoopSec = sec;
  //   }
  // } else {
  //   is_already_called = false;
  // }
  // lastSec = sec;
}
}

#undef WASM_EXPORT

#endif // CANVAS_MAIN_H_
